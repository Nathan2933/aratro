<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Manager Registration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        #map {
            height: 300px;
            width: 100%;
            margin-bottom: 15px;
        }
        .form-container {
            max-width: 800px;
            margin: 30px auto;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border-radius: 10px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container">
        <div class="form-container bg-white">
            <h2 class="text-center mb-4">Warehouse Registration</h2>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <form id="registrationForm" method="POST" action="{{ url_for('auth.warehouse_register') }}">
                <div class="mb-3">
                    <label for="managerName" class="form-label">Manager Name</label>
                    <input type="text" class="form-control" id="managerName" name="managerName" required>
                </div>

                <div class="mb-3">
                    <label for="warehouseName" class="form-label">Warehouse Name</label>
                    <input type="text" class="form-control" id="warehouseName" name="warehouseName" required>
                </div>

                <div class="mb-3">
                    <label for="phoneNumber" class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" required>
                </div>

                <div class="mb-3">
                    <label for="warehouseType" class="form-label">Warehouse Type</label>
                    <select class="form-control" id="warehouseType" name="warehouseType" required>
                        <option value="">Select Type</option>
                        <option value="private">Private</option>
                        <option value="government">Government</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="capacity" class="form-label">Storage Capacity (in tons)</label>
                    <input type="number" step="0.01" class="form-control" id="capacity" name="capacity" required>
                </div>

                <div class="mb-3">
                    <label for="location" class="form-label">Location</label>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" id="location" name="location" placeholder="Search for a location" required>
                        <button type="button" class="btn btn-primary" id="getCurrentLocation">
                            <i class="fas fa-location-dot"></i> Current Location
                        </button>
                    </div>
                    <div id="map" style="height: 300px; width: 100%; margin-bottom: 15px;"></div>
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-100">Register</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Form validation
        document.getElementById('registrationForm').addEventListener('submit', function(e) {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;

            if (password !== confirmPassword) {
                e.preventDefault();
                alert('Passwords do not match!');
                return;
            }

            if (!latitude || !longitude) {
                e.preventDefault();
                alert('Please select a location on the map');
                return;
            }

            // Log form data before submission
            console.log('Form submission:', {
                lat: latitude,
                lng: longitude,
                location: document.getElementById('location').value
            });
        });

        // Initialize Google Maps
        let map;
        let marker;
        let autocomplete;

        function initMap() {
            const defaultLocation = { lat: 20.5937, lng: 78.9629 }; // Center of India

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 5,
                center: defaultLocation,
            });

            // Initialize Places Autocomplete
            const input = document.getElementById('location');
            autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo('bounds', map);

            // Create marker for selected location
            marker = new google.maps.Marker({
                map: map,
                draggable: true
            });

            // Listen for place selection
            autocomplete.addListener('place_changed', function() {
                const place = autocomplete.getPlace();
                if (!place.geometry) {
                    return;
                }

                // Update map and marker
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }

                marker.setPosition(place.geometry.location);
                updateLocationFields(place);
            });

            // Update fields when marker is dragged
            marker.addListener('dragend', function() {
                const position = marker.getPosition();
                reverseGeocode(position);
            });

            // Add click listener to map
            map.addListener('click', function(e) {
                marker.setPosition(e.latLng);
                reverseGeocode(e.latLng);
            });
        }

        function updateLocationFields(place) {
            document.getElementById('latitude').value = place.geometry.location.lat();
            document.getElementById('longitude').value = place.geometry.location.lng();
            document.getElementById('location').value = place.formatted_address;
            console.log('Location updated:', {  // Debug log
                lat: document.getElementById('latitude').value,
                lng: document.getElementById('longitude').value,
                address: document.getElementById('location').value
            });
        }

        function reverseGeocode(latLng) {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ location: latLng }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    document.getElementById('location').value = results[0].formatted_address;
                    document.getElementById('latitude').value = latLng.lat();
                    document.getElementById('longitude').value = latLng.lng();
                    console.log('Reverse geocoded:', {  // Debug log
                        lat: document.getElementById('latitude').value,
                        lng: document.getElementById('longitude').value,
                        address: document.getElementById('location').value
                    });
                }
            });
        }

        // Get current location
        document.getElementById('getCurrentLocation').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        map.setCenter(pos);
                        map.setZoom(17);
                        marker.setPosition(pos);
                        reverseGeocode(pos);
                    },
                    function(error) {
                        let message = 'Error getting your location: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                message += 'Permission denied';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message += 'Position unavailable';
                                break;
                            case error.TIMEOUT:
                                message += 'Timeout';
                                break;
                        }
                        alert(message);
                    }
                );
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        });
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&libraries=places&callback=initMap" async defer></script>
</body>
</html>
