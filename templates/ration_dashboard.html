{% extends "base.html" %}

{% block content %}
<h1>Ration Shop Dashboard</h1>

<div class="dashboard-stats">
    <div class="stat-card">
        <h3>{{ warehouses|length }}</h3>
        <p>Available Warehouses</p>
    </div>
    <div class="stat-card">
        <h3>{{ requests|length }}</h3>
        <p>Stock Requests</p>
    </div>
</div>

<div class="card">
    <h2>Request Stock from Warehouse</h2>
    <form id="request-form">
        <div class="form-group">
            <label for="warehouse">Select Warehouse</label>
            <select class="form-control" id="warehouse" required>
                {% for warehouse in warehouses %}
                <option value="{{ warehouse.id }}">{{ warehouse.name }} - {{ warehouse.location }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="stock_type">Stock Type</label>
            <select class="form-control" id="stock_type" required>
                <!-- Will be populated dynamically based on warehouse selection -->
            </select>
        </div>
        <div class="form-group">
            <label for="quantity">Quantity (tons)</label>
            <input type="number" class="form-control" id="quantity" step="0.01" required>
        </div>
        <button type="submit" class="btn btn-primary">Submit Request</button>
    </form>
</div>

<div class="card">
    <h2>My Requests</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Request ID</th>
                <th>Warehouse</th>
                <th>Stock Type</th>
                <th>Quantity (tons)</th>
                <th>Status</th>
                <th>Request Date</th>
            </tr>
        </thead>
        <tbody>
            {% for request in requests %}
            <tr>
                <td>{{ request.id }}</td>
                <td>{{ request.warehouse.name }}</td>
                <td>{{ request.stock.type }}</td>
                <td>{{ request.quantity }}</td>
                <td>{{ request.status }}</td>
                <td>{{ request.request_date.strftime('%Y-%m-%d') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
$('#warehouse').change(function() {
    const warehouseId = $(this).val();
    // Fetch available stocks for selected warehouse
    $.get(`/warehouse/${warehouseId}/stocks`)
        .done(function(response) {
            const stockSelect = $('#stock_type');
            stockSelect.empty();
            response.stocks.forEach(stock => {
                stockSelect.append(`<option value="${stock.id}">${stock.type} (Available: ${stock.quantity} tons)</option>`);
            });
        });
});

$('#request-form').submit(function(e) {
    e.preventDefault();
    $.post('/request_stock', {
        stock_id: $('#stock_type').val(),
        quantity: $('#quantity').val()
    })
    .done(function(response) {
        showAlert('Stock request submitted successfully', 'success');
        setTimeout(() => location.reload(), 1000);
    })
    .fail(function(error) {
        showAlert('Failed to submit stock request', 'error');
    });
});
</script>
{% endblock %}
