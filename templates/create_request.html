{% extends "base.html" %}

{% block title %}Create Request{% endblock %}

{% block content %}
<div class="container-fluid farmer-dashboard p-0">
    <div class="row g-0">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block sidebar-wrapper" id="farmerSidebar">
            <div class="position-sticky">
                <div class="sidebar-header">
                    <h5 class="sidebar-brand">
                        <span class="company-name" style="font-size: 1.5rem; font-weight: 600; color: white; text-align: center; width: 100%;">
                            <i class="bi bi-link-45deg" style="font-size: 1.8rem; margin-right: 5px;"></i>
                            Aratro
                        </span>
                    </h5>
                </div>
                <div class="user-info" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; padding: 10px 0;">
                    <div class="user-avatar">
                        <i class="bi bi-person-circle" style="font-size: 2.5rem;"></i>
                    </div>
                    <div class="user-details">
                        <span class="user-name">{% if user_farmer %}{{ user_farmer.name }}{% elif current_user.is_authenticated %}{{ current_user.username }}{% elif farmer %}{{ farmer.name }}{% else %}Farmer{% endif %}</span>
                        <span class="user-role">Farmer</span>
                    </div>
                </div>
                
                <ul class="nav flex-column sidebar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('farmer_dashboard.farmer_home') }}">
                            <i class="bi bi-grid-1x2-fill me-2"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('farmer_dashboard.create_request_page') }}">
                            <i class="bi bi-file-earmark-plus-fill me-2"></i>
                            <span>Create Request</span>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('farmer_dashboard.view_warehouse_announcements') }}">
                            <i class="bi bi-megaphone-fill me-2"></i>
                            <span>Warehouse Announcements</span>
                        </a>
                    </li>
                    
                    <li class="nav-heading">Request Status</li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('farmer_dashboard.accepted_requests') }}">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <span>Accepted Requests</span>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('farmer_dashboard.pending_requests') }}">
                            <i class="bi bi-clock-fill me-2"></i>
                            <span>Pending Requests</span>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('farmer_dashboard.rejected_requests') }}">
                            <i class="bi bi-x-circle-fill me-2"></i>
                            <span>Rejected Requests</span>
                        </a>
                    </li>
                    
                    <li class="sidebar-divider"></li>
                    
                    <li class="nav-item">
                        <a class="nav-link text-danger" href="{{ url_for('auth.logout') }}">
                            <i class="bi bi-box-arrow-right me-2"></i>
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
                
                <div class="sidebar-footer">
                    <!-- User info moved to header -->
                </div>
            </div>
        </div>
        
        <!-- Mobile Sidebar Toggle -->
        <div class="mobile-sidebar-toggle d-md-none">
            <button class="btn btn-sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 main-content">
            <div class="content-wrapper">
                <!-- Page Header -->
                <div class="dashboard-header text-center">
                    <h1 class="dashboard-title">Create Request</h1>
                    <p class="dashboard-subtitle">Submit a new stock request to warehouses</p>
                </div>
                
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <!-- Create Request Form -->
                <div class="card stock-request-card">
                    <div class="card-header">
                        <h2>New Stock Request</h2>
                    </div>
                    <div class="card-body">
                        <form id="newRequestForm" action="{{ url_for('farmer_dashboard.submit_request') }}" method="POST">
                            <div class="form-group mb-3">
                                <label for="warehouseSelect" class="form-label">Selected Warehouse</label>
                                <div class="selected-warehouse-container p-3 border rounded mb-3" id="selectedWarehouseContainer" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h3 id="selectedWarehouseName" class="fs-5 fw-bold"></h3>
                                            <p id="selectedWarehouseAddress" class="small mb-1"></p>
                                            <p class="small">Available Space: <span id="selectedWarehouseSpace"></span> tons</p>
                                        </div>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearSelectedWarehouse()">
                                            <i class="fas fa-times"></i> Change
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" id="warehouseId" name="warehouse_id" required>
                                <div id="warehouseSelectPrompt">
                                    <p class="mb-3">Please select a warehouse from the map or list below</p>
                                </div>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="stockType" class="form-label">Stock Type</label>
                                <select id="stockType" name="stock_type" class="form-select" required>
                                    <option value="">-- Select Stock Type --</option>
                                    <option value="Rice" {% if warehouse_request and warehouse_request.stock_type == 'Rice' %}selected{% endif %}>Rice</option>
                                    <option value="Wheat" {% if warehouse_request and warehouse_request.stock_type == 'Wheat' %}selected{% endif %}>Wheat</option>
                                    <option value="Corn" {% if warehouse_request and warehouse_request.stock_type == 'Corn' %}selected{% endif %}>Corn</option>
                                    <option value="Sugarcane" {% if warehouse_request and warehouse_request.stock_type == 'Sugarcane' %}selected{% endif %}>Sugarcane</option>
                                    <option value="Vegetables" {% if warehouse_request and warehouse_request.stock_type == 'Vegetables' %}selected{% endif %}>Vegetables</option>
                                    <option value="Fruits" {% if warehouse_request and warehouse_request.stock_type == 'Fruits' %}selected{% endif %}>Fruits</option>
                                    <option value="Other" {% if warehouse_request and warehouse_request.stock_type not in ['Rice', 'Wheat', 'Corn', 'Sugarcane', 'Vegetables', 'Fruits'] %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                            <div class="form-group mb-3" id="otherStockTypeGroup" {% if warehouse_request and warehouse_request.stock_type not in ['Rice', 'Wheat', 'Corn', 'Sugarcane', 'Vegetables', 'Fruits'] %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                                <label for="otherStockType" class="form-label">Specify Stock Type</label>
                                <input type="text" id="otherStockType" name="other_stock_type" class="form-control" placeholder="Enter stock type" {% if warehouse_request and warehouse_request.stock_type not in ['Rice', 'Wheat', 'Corn', 'Sugarcane', 'Vegetables', 'Fruits'] %}value="{{ warehouse_request.stock_type }}"{% endif %}>
                            </div>
                            <div class="form-group mb-3">
                                <label for="quantity" class="form-label">Quantity (tons)</label>
                                <input type="number" id="quantity" name="quantity" class="form-control" min="0.01" step="0.01" required value="{% if warehouse_request %}{{ warehouse_request.quantity }}{% endif %}">
                            </div>
                            {% if warehouse_request %}
                            <div class="form-group mb-3">
                                <div class="alert alert-info">
                                    <h4>Warehouse Request Details</h4>
                                    <p><strong>Price Offered:</strong> â‚¹{{ warehouse_request.price_per_ton }}/ton</p>
                                    <p><strong>Posted Date:</strong> {{ warehouse_request.date_posted.strftime('%Y-%m-%d') }}</p>
                                    <p><strong>Expiry Date:</strong> {{ warehouse_request.expiry_date.strftime('%Y-%m-%d') }}</p>
                                    {% if warehouse_request.description %}
                                    <p><strong>Description:</strong> {{ warehouse_request.description }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            <div class="form-group mb-3">
                                <label for="notes" class="form-label">Additional Notes</label>
                                <textarea id="notes" name="notes" class="form-control" rows="3"></textarea>
                            </div>
                            
                            <div class="form-actions d-flex gap-2 mt-4">
                                <a href="{{ url_for('farmer_dashboard.farmer_home') }}" class="btn btn-outline-secondary">Cancel</a>
                                <button type="submit" class="btn btn-primary" id="submitButton" disabled>
                                    <i class="fas fa-paper-plane me-1"></i>
                                    Submit Request
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Right side: Map -->
                <div class="card warehouse-card mt-4">
                    <div class="card-header">
                        <h2>Nearby Warehouses</h2>
                    </div>
                    <div class="card-body">
                        <div id="map" style="height: 400px; width: 100%; margin-bottom: 20px;"></div>
                        <div class="warehouse-list-container">
                            <h3 class="mb-3">Available Warehouses</h3>
                            <div class="table-container">
                                <table class="table" id="warehousesTable">
                                    <thead>
                                        <tr>
                                            <th>Warehouse Name</th>
                                            <th>Location</th>
                                            <th>Type</th>
                                            <th>Available Space</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for warehouse in warehouses %}
                                        <tr data-id="{{ warehouse.id }}" 
                                            data-name="{{ warehouse.name }}" 
                                            data-location="{{ warehouse.location }}" 
                                            data-lat="{{ warehouse.latitude }}" 
                                            data-lng="{{ warehouse.longitude }}" 
                                            data-type="{{ warehouse.warehouse_type }}" 
                                            data-space="{{ warehouse.available_space }}"
                                            {% if warehouse_request and warehouse_request.warehouse_id == warehouse.id %}
                                            data-request-id="{{ warehouse_request.id }}"
                                            {% endif %}>
                                            <td>{{ warehouse.name }}</td>
                                            <td>{{ warehouse.location }}</td>
                                            <td>{{ warehouse.warehouse_type|capitalize }}</td>
                                            <td>{{ warehouse.available_space }} tons</td>
                                            <td>
                                                <button class="btn btn-primary btn-sm select-warehouse" data-id="{{ warehouse.id }}">
                                                    <i class="fas fa-check"></i>
                                                    Select
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% if not warehouses %}
                                        <tr>
                                            <td colspan="5" class="text-center">
                                                <div class="empty-state-container py-5">
                                                    <i class="fas fa-warehouse fa-3x mb-3"></i>
                                                    <p class="mb-3">No nearby warehouses found</p>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    body{
        margin-top: 50px;
        padding-top: 0px;
        margin-right: 0px;
        padding-right:0px;
        margin-left: 100px;
    }
    /* Dashboard Layout */
    .farmer-dashboard {
        background-color: #f5f7fa;
        position: relative;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
    }
    .content-area{
        margin-left: 80px;
    }
    .main-content {
        padding: 2rem;
        transition: all 0.3s;
        display: flex;
        justify-content: center;
        width: 100%;
        height: fit-content;
        overflow: visible;
        padding-left: 100px;
    }
    
    .content-wrapper {
        width: 100%;
        max-width: 1200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: fit-content;
        overflow: visible;
    }
    
    /* Card Styles */
    .stock-request-card,
    .warehouse-card {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        width: 100%;
        border: 1px solid #e2e8f0;
        margin-bottom: 1.5rem;
    }
    
    .stock-request-card .card-header,
    .warehouse-card .card-header {
        background-color: #f0f9f0;
        border-bottom: 1px solid #e2e8f0;
        padding: 1rem 1.5rem;
    }
    
    .stock-request-card .card-header h2,
    .warehouse-card .card-header h2 {
        color: #2d6b45;
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }
    
    .stock-request-card .card-body,
    .warehouse-card .card-body {
        padding: 1.5rem;
    }
    
    /* Form Styles */
    .form-label {
        font-weight: 500;
        color: #4a5568;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .form-control,
    .form-select {
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        width: 100%;
        transition: border-color 0.15s ease-in-out;
    }
    
    .form-control:focus,
    .form-select:focus {
        border-color: #55c759;
        box-shadow: 0 0 0 3px rgba(85, 199, 89, 0.1);
        outline: none;
    }
    
    .btn-primary {
        background-color: #55c759;
        border-color: #55c759;
    }
    
    .btn-primary:hover {
        background-color: #46a64a;
        border-color: #46a64a;
    }
    
    .btn-outline-secondary {
        color: #4a5568;
        border-color: #cbd5e0;
    }
    
    .btn-outline-secondary:hover {
        background-color: #f7fafc;
        color: #2d3748;
    }
    
    /* Dashboard Header */
    .dashboard-header {
        margin-bottom: 2rem;
        width: 100%;
    }
    
    .dashboard-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
        position: relative;
        display: inline-block;
    }
    
    .dashboard-title::after {
        content: '';
        position: absolute;
        bottom: -0.5rem;
        left: 50%;
        transform: translateX(-50%);
        width: 3rem;
        height: 0.25rem;
        background: var(--primary-color);
        border-radius: 0.125rem;
    }
    
    .dashboard-subtitle {
        color: #6c757d;
        font-size: 1rem;
    }
    
    /* Sidebar Styles */
    .sidebar-brand {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        text-align: center;
        padding: 10px 0;
    }
    
    .sidebar-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }
    
    .user-info {
        text-align: center;
    }
    
    .user-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        color: #e2e8f0;
    }
    
    .user-details {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }
    
    .user-name {
        font-size: 1rem;
        font-weight: 600;
        color: #e2e8f0;
        margin-bottom: 2px;
        text-align: center;
    }
    
    .user-role {
        font-size: 0.8rem;
        color: #a0aec0;
        text-align: center;
    }
    
    /* Remove bullet points from sidebar navigation */
    .sidebar-nav {
        list-style-type: none;
        padding-left: 0;
    }
    
    /* Remove any default list styling that might be causing the white dot */
    .sidebar-nav li {
        list-style: none;
    }
    
    .sidebar-divider {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        margin: 10px 0;
        list-style: none;
    }
    
    /* Dashboard Card */
    .dashboard-card {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        width: 100%;
        height: fit-content;
        margin-bottom: 2rem;
    }
    
    .dashboard-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .dashboard-card-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #2d3748;
        margin: 0;
        display: flex;
        align-items: center;
    }
    
    .dashboard-card-title i {
        color: #4a5568;
        margin-right: 0.75rem;
    }
    
    /* Fix for container height */
    .row {
        display: flex;
        flex-wrap: wrap;
        height: fit-content;
    }
    
    .container-fluid {
        height: fit-content;
        min-height: 0;
    }
    
    /* Responsive adjustments */
    @media (max-width: 1200px) {
        .dashboard-card {
            width: 100%;
        }
    }
    @media screen and (max-width: 768px) {
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .content-area{
        margin-left: 0px;
    }
        .main-content {
            padding: 0;
            margin: 0;
            width: 100vw;
        }

        .content-wrapper {
            padding: 0.5rem;
            width: 100%;
        }

        .dashboard-header {
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .dashboard-title {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
            width: 100%;
            text-align: center;
        }

        .dashboard-subtitle {
            font-size: 0.9rem;
            margin: 0.5rem 0;
            width: 100%;
        }

        .dashboard-card {
            margin: 0.5rem 0;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .dashboard-card-header {
            padding: 1rem;
        }

        .card-body {
            padding: 1rem;
        }

        .search-container {
            margin: 0.75rem 0;
            padding: 0;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
        }

        .input-group input {
            padding: 0.75rem;
            font-size: 0.9rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            flex: 1;
        }

        .rejected-requests-grid {
            padding: 0.5rem;
            margin: 0;
        }

        .rejected-request-card {
            margin: 0.75rem 0;
            padding: 1rem;
            border-radius: 8px;
        }

        .card-header {
            padding: 0.75rem 0;
            margin-bottom: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .request-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .request-info strong {
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 0.25rem;
        }

        .badge-error {
            align-self: flex-start;
            margin-top: 0.25rem;
        }

        .view-details-btn {
            width: 100%;
            text-align: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: #f7fafc;
        }

        .stock-details,
        .warehouse-details {
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 8px;
        }

        .detail-group {
            padding: 0.5rem 0;
            border-bottom: 1px solid #edf2f7;
        }

        .detail-group:last-child {
            border-bottom: none;
        }

        .warehouse-details h4 {
            font-size: 1rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .action-buttons {
            margin-top: 1rem;
            padding-top: 0.5rem;
        }

        .btn-primary {
            width: 100%;
            justify-content: center;
            padding: 0.75rem;
            font-size: 0.9rem;
        }

        /* Improve spacing between elements */
        * + * {
            margin-top: 0.5rem;
        }

        /* Reset margin for specific elements */
        .dashboard-card > *:first-child {
            margin-top: 0;
        }
    }
    

    @media (max-width: 768px) {
        .main-content {
            padding: 1.5rem 1rem;
        }
    }
    
    /* Keep existing styles */
    .selected-row {
        background-color: rgba(0, 123, 255, 0.1);
    }
    
    .map-select-btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 5px;
    }
    
    .map-select-btn:hover {
        background-color: #0056b3;
    }
    
    .info-window {
        padding: 5px;
        max-width: 200px;
    }
    
    .info-window h3 {
        margin-top: 0;
        margin-bottom: 5px;
        font-size: 16px;
    }
    
    .info-window p {
        margin: 3px 0;
        font-size: 14px;
    }
</style>

<script src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&callback=initMap" async defer></script>
<script>
let map;
let markers = [];
let infoWindow;
let warehouses = [];

function initMap() {
    // Default center (India)
    const defaultCenter = { lat: 20.5937, lng: 78.9629 };
    
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 5,
        center: defaultCenter,
    });
    
    // Try to get user's current location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // Add marker for user location
                new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: "#4285F4",
                        fillOpacity: 1,
                        strokeColor: "#FFFFFF",
                        strokeWeight: 2,
                    },
                    title: "Your Location"
                });
                
                // Center map on user location and zoom in
                map.setCenter(userLocation);
                map.setZoom(10);
                
                // Load warehouses after getting user location
                loadWarehouses();
            },
            () => {
                // If geolocation fails, just load warehouses with default center
                loadWarehouses();
            }
        );
    } else {
        // Browser doesn't support geolocation
        loadWarehouses();
    }
}

// Load warehouse data and add markers
function loadWarehouses() {
    warehouses = [];
    
    // Get warehouse data from the table
    document.querySelectorAll('#warehousesTable tbody tr:not([colspan])').forEach(row => {
        if (!row.hasAttribute('data-id')) return;
        
        const warehouse = {
            id: row.getAttribute('data-id'),
            name: row.getAttribute('data-name'),
            location: row.getAttribute('data-location'),
            lat: parseFloat(row.getAttribute('data-lat')),
            lng: parseFloat(row.getAttribute('data-lng')),
            type: row.getAttribute('data-type'),
            availableSpace: row.getAttribute('data-space')
        };
        
        warehouses.push(warehouse);
        addWarehouseMarker(warehouse);
    });
    
    // If we have warehouses and user location, fit bounds to include all
    if (warehouses.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        
        // Add user location to bounds if available
        if (userLocation) {
            bounds.extend(userLocation);
        }
        
        // Add all warehouse locations to bounds
        markers.forEach(marker => {
            bounds.extend(marker.getPosition());
        });
        
        map.fitBounds(bounds);
        
        // Don't zoom in too far
        const listener = google.maps.event.addListener(map, "idle", () => {
            if (map.getZoom() > 12) {
                map.setZoom(12);
            }
            google.maps.event.removeListener(listener);
        });
    }
}

// Add a marker for a warehouse
function addWarehouseMarker(warehouse) {
    const marker = new google.maps.Marker({
        position: { lat: warehouse.lat, lng: warehouse.lng },
        map: map,
        title: warehouse.name,
        icon: {
            url: warehouse.type === 'government' ? 
                'https://maps.google.com/mapfiles/ms/icons/blue-dot.png' : 
                'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
        }
    });
    
    // Create info window content
    const contentString = `
        <div class="info-window">
            <h3>${warehouse.name}</h3>
            <p>${warehouse.location}</p>
            <p>Type: ${warehouse.type.charAt(0).toUpperCase() + warehouse.type.slice(1)}</p>
            <p>Available Space: ${warehouse.availableSpace} tons</p>
            <button class="map-select-btn" onclick="selectWarehouseFromMap('${warehouse.id}')">Select This Warehouse</button>
        </div>
    `;
    
    const infowindow = new google.maps.InfoWindow({
        content: contentString,
    });
    
    // Add click listener to open info window
    marker.addListener("click", () => {
        infowindow.open(map, marker);
    });
    
    markers.push(marker);
    return marker;
}

// Select warehouse from map button click
function selectWarehouseFromMap(warehouseId) {
    selectWarehouse(warehouseId);
}

// Select warehouse function
function selectWarehouse(warehouseId) {
    const warehouse = warehouses.find(w => w.id === warehouseId);
    if (!warehouse) return;
    
    // Update hidden input
    document.getElementById('warehouseId').value = warehouse.id;
    
    // Update display
    document.getElementById('selectedWarehouseName').textContent = warehouse.name;
    document.getElementById('selectedWarehouseAddress').textContent = warehouse.location;
    document.getElementById('selectedWarehouseSpace').textContent = warehouse.availableSpace;
    
    // Show selected warehouse info and hide prompt
    document.getElementById('selectedWarehouseContainer').style.display = 'block';
    document.getElementById('warehouseSelectPrompt').style.display = 'none';
    
    // Enable submit button
    document.getElementById('submitButton').disabled = false;
    
    // Highlight selected row in table
    document.querySelectorAll('#warehousesTable tbody tr').forEach(row => {
        if (row.getAttribute('data-id') === warehouseId) {
            row.classList.add('selected-row');
        } else {
            row.classList.remove('selected-row');
        }
    });
    
    // Center map on selected warehouse
    map.setCenter({ lat: warehouse.lat, lng: warehouse.lng });
    map.setZoom(15);
}

// Clear selected warehouse
function clearSelectedWarehouse() {
    document.getElementById('warehouseId').value = '';
    document.getElementById('selectedWarehouseContainer').style.display = 'none';
    document.getElementById('warehouseSelectPrompt').style.display = 'block';
    document.getElementById('submitButton').disabled = true;
    
    // Remove highlight from table
    document.querySelectorAll('#warehousesTable tbody tr').forEach(row => {
        row.classList.remove('selected-row');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Handle "Other" stock type selection
    document.getElementById('stockType').addEventListener('change', function() {
        const otherGroup = document.getElementById('otherStockTypeGroup');
        if (this.value === 'Other') {
            otherGroup.style.display = 'block';
        } else {
            otherGroup.style.display = 'none';
        }
    });
    
    // Add click handlers for select buttons in table
    document.querySelectorAll('.select-warehouse').forEach(button => {
        button.addEventListener('click', function() {
            const warehouseId = this.getAttribute('data-id');
            selectWarehouse(warehouseId);
        });
    });
    
    // Form submission handling
    document.getElementById('newRequestForm').addEventListener('submit', function(event) {
        if (this.checkValidity()) {
            const stockType = document.getElementById('stockType').value;
            if (stockType === 'Other') {
                const otherStockType = document.getElementById('otherStockType').value;
                if (!otherStockType.trim()) {
                    event.preventDefault();
                    alert('Please specify the stock type.');
                    return false;
                }
            }
            
            const warehouseId = document.getElementById('warehouseId').value;
            if (!warehouseId) {
                event.preventDefault();
                alert('Please select a warehouse.');
                return false;
            }
        }
    });
    
    // Check for warehouse_id parameter in URL
    const urlParams = new URLSearchParams(window.location.search);
    const warehouseIdParam = urlParams.get('warehouse_id');
    const warehouseRequestIdParam = urlParams.get('warehouse_request_id');
    const stockTypeParam = urlParams.get('stock_type');
    const quantityParam = urlParams.get('quantity');
    
    // Pre-fill stock type if provided
    if (stockTypeParam) {
        const stockTypeSelect = document.getElementById('stockType');
        const stockTypeOption = Array.from(stockTypeSelect.options).find(option => option.value === stockTypeParam);
        
        if (stockTypeOption) {
            stockTypeOption.selected = true;
        } else {
            // If stock type is not in predefined list, select "Other" and fill in the custom field
            const otherOption = Array.from(stockTypeSelect.options).find(option => option.value === 'Other');
            if (otherOption) {
                otherOption.selected = true;
                document.getElementById('otherStockTypeGroup').style.display = 'block';
                document.getElementById('otherStockType').value = stockTypeParam;
            }
        }
    }
    
    // Pre-fill quantity if provided
    if (quantityParam) {
        document.getElementById('quantity').value = quantityParam;
    }
    
    if (warehouseIdParam) {
        console.log("Found warehouse_id in URL:", warehouseIdParam);
        // We need to wait for the map to initialize and warehouses to load
        // before we can select the warehouse
        const checkWarehousesLoaded = setInterval(function() {
            if (warehouses.length > 0) {
                clearInterval(checkWarehousesLoaded);
                selectWarehouse(warehouseIdParam);
                
                // Scroll to the form section
                document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
            }
        }, 500);
    } else if (warehouseRequestIdParam) {
        console.log("Found warehouse_request_id in URL:", warehouseRequestIdParam);
        // Handle warehouse request selection
        const checkWarehousesLoaded = setInterval(function() {
            if (warehouses.length > 0) {
                clearInterval(checkWarehousesLoaded);
                // Find the warehouse associated with this request
                const warehouseRow = document.querySelector(`tr[data-request-id="${warehouseRequestIdParam}"]`);
                if (warehouseRow) {
                    const warehouseId = warehouseRow.getAttribute('data-warehouse-id');
                    selectWarehouse(warehouseId);
                }
                // Scroll to the form section
                document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
            }
        }, 500);
    }

    // Mobile sidebar toggle
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('farmerSidebar');
    const closeSidebarBtn = document.getElementById('closeSidebarBtn');
    
    if (sidebarToggle && sidebar) {
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.add('show');
            document.body.classList.add('sidebar-open');
        });
        
        if (closeSidebarBtn) {
            closeSidebarBtn.addEventListener('click', function() {
                sidebar.classList.remove('show');
                document.body.classList.remove('sidebar-open');
            });
        }
        
        // Close sidebar when clicking outside
        document.addEventListener('click', function(event) {
            const isClickInsideSidebar = sidebar.contains(event.target);
            const isClickOnToggle = sidebarToggle.contains(event.target);
            
            if (!isClickInsideSidebar && !isClickOnToggle && sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                document.body.classList.remove('sidebar-open');
            }
        });
        
        // Close sidebar when pressing Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                document.body.classList.remove('sidebar-open');
            }
        });
    }
});
</script>
{% endblock %}