{% extends "base.html" %}

{% block content %}
<div class="flex justify-between items-center mb-4">
    <h1>Farmer Dashboard</h1>
    <a href="{{ url_for('farmer_dashboard.create_request_page') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        New Stock Request
    </a>
</div>

<div class="dashboard-stats">
    <div class="stat-card">
        <i class="fas fa-clock fa-2x mb-3"></i>
        <h3>{{ requests|selectattr('status', 'equalto', 'pending')|list|length }}</h3>
        <p>Pending Requests</p>
    </div>
    <div class="stat-card">
        <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
        <h3>{{ requests|selectattr('status', 'equalto', 'approved')|list|length }}</h3>
        <p>Approved Requests</p>
    </div>
    <div class="stat-card">
        <i class="fas fa-times-circle fa-2x mb-3 text-error"></i>
        <h3>{{ requests|selectattr('status', 'equalto', 'rejected')|list|length }}</h3>
        <p>Rejected Requests</p>
    </div>
    <div class="stat-card">
        <i class="fas fa-warehouse fa-2x mb-3"></i>
        <h3>{{ warehouses|length }}</h3>
        <p>Nearby Warehouses</p>
    </div>
</div>

<div class="flex gap-3 mb-4">
    <div class="card" style="flex: 2;">
        <div class="flex justify-between items-center mb-3">
            <h2>Request Status Overview</h2>
            <div class="flex gap-2">
                <select id="timeFilter" class="form-select">
                    <option value="all">All Time</option>
                    <option value="week">Last Week</option>
                    <option value="month">Last Month</option>
                    <option value="year">Last Year</option>
                </select>
            </div>
        </div>
        <div class="mt-4">
            <div class="status-group mb-4">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center">
                        <span class="status-dot warning"></span>
                        <span>Pending</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold">{{ requests|selectattr('status', 'equalto', 'pending')|list|length }}</span>
                        <span class="text-sm text-muted">requests</span>
                    </div>
                </div>
                <div class="progress-container">
                    {% set pending_percentage = (requests|selectattr('status', 'equalto', 'pending')|list|length / requests|length * 100)|round if requests|length > 0 else 0 %}
                    <div class="progress-bar warning" style="width: {{ pending_percentage }}%">
                        <span class="progress-text">{{ pending_percentage }}%</span>
                    </div>
                </div>
            </div>
            
            <div class="status-group mb-4">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center">
                        <span class="status-dot success"></span>
                        <span>Approved</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold">{{ requests|selectattr('status', 'equalto', 'approved')|list|length }}</span>
                        <span class="text-sm text-muted">requests</span>
                    </div>
                </div>
                <div class="progress-container">
                    {% set approved_percentage = (requests|selectattr('status', 'equalto', 'approved')|list|length / requests|length * 100)|round if requests|length > 0 else 0 %}
                    <div class="progress-bar success" style="width: {{ approved_percentage }}%">
                        <span class="progress-text">{{ approved_percentage }}%</span>
                    </div>
                </div>
            </div>
            
            <div class="status-group mb-4">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center">
                        <span class="status-dot error"></span>
                        <span>Rejected</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold">{{ requests|selectattr('status', 'equalto', 'rejected')|list|length }}</span>
                        <span class="text-sm text-muted">requests</span>
                    </div>
                </div>
                <div class="progress-container">
                    {% set rejected_percentage = (requests|selectattr('status', 'equalto', 'rejected')|list|length / requests|length * 100)|round if requests|length > 0 else 0 %}
                    <div class="progress-bar error" style="width: {{ rejected_percentage }}%">
                        <span class="progress-text">{{ rejected_percentage }}%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card" style="flex: 1;">
        <h2>Quick Actions</h2>
        <div class="mt-4">
            <a href="{{ url_for('farmer_dashboard.create_request_page') }}" class="btn btn-primary w-full mb-3">
                <i class="fas fa-plus"></i>
                Create New Request
            </a>
            <button class="btn btn-outline w-full mb-3" id="viewMapBtnAlt">
                <i class="fas fa-map-marker-alt"></i>
                View Warehouse Map
            </button>
            <button class="btn btn-outline w-full mb-3">
                <i class="fas fa-history"></i>
                View Request History
            </button>
            <button class="btn btn-outline w-full">
                <i class="fas fa-download"></i>
                Export Requests
            </button>
        </div>
    </div>
</div>

<div class="card">
    <div class="flex justify-between items-center mb-3">
        <h2>Stock Requests</h2>
        <div class="flex gap-2">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search requests..." id="requestSearch" class="search-input">
            </div>
            <button class="btn btn-outline">
                <i class="fas fa-filter"></i>
                Filter
            </button>
            <button class="btn btn-outline">
                <i class="fas fa-sort"></i>
                Sort
            </button>
        </div>
    </div>
    <div class="table-container">
        <table class="table" id="requestsTable">
            <thead>
                <tr>
                    <th>Request ID</th>
                    <th>Stock Type</th>
                    <th>Quantity (tons)</th>
                    <th>Warehouse</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for request in requests %}
                <tr>
                    <td>#{{ request.id }}</td>
                    <td>{{ request.stock.type }}</td>
                    <td>{{ request.quantity }}</td>
                    <td>{{ request.warehouse.name }}</td>
                    <td>{{ request.request_date.strftime('%Y-%m-%d') }}</td>
                    <td>
                        {% if request.status == 'pending' %}
                        <span class="badge badge-warning">Pending</span>
                        {% elif request.status == 'approved' %}
                        <span class="badge badge-success">Approved</span>
                        {% elif request.status == 'rejected' %}
                        <span class="badge badge-error">Rejected</span>
                        {% else %}
                        <span class="badge badge-info">{{ request.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="flex gap-2">
                            {% if request.status == 'pending' %}
                            <button class="btn-icon btn-success" onclick="updateRequest({{ request.id }}, 'approved')" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn-icon btn-danger" onclick="updateRequest({{ request.id }}, 'rejected')" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>
                            {% else %}
                            <button class="btn-icon btn-primary" onclick="viewDetails({{ request.id }})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% if not requests %}
                <tr>
                    <td colspan="7" class="text-center">
                        <div class="empty-state-container py-5">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p class="mb-3">No stock requests found</p>
                            <a href="{{ url_for('farmer_dashboard.create_request_page') }}" class="btn btn-primary">
                                <i class="fas fa-plus"></i>
                                Create New Request
                            </a>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<div class="card mt-4">
    <div class="flex justify-between items-center mb-3">
        <h2>Nearby Warehouses</h2>
        <div class="flex gap-2">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search warehouses..." id="warehouseSearch" class="search-input">
            </div>
            <button class="btn btn-outline" id="viewMapBtn">
                <i class="fas fa-map-marker-alt"></i>
                View Map
            </button>
        </div>
    </div>
    <div class="table-container">
        <table class="table" id="warehousesTable">
            <thead>
                <tr>
                    <th>Warehouse Name</th>
                    <th>Location</th>
                    <th>Type</th>
                    <th>Available Space (tons)</th>
                    <th>Total Capacity (tons)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for warehouse in warehouses %}
                <tr>
                    <td>{{ warehouse.name }}</td>
                    <td>{{ warehouse.location }}</td>
                    <td>{{ warehouse.warehouse_type|capitalize }}</td>
                    <td>{{ warehouse.available_space }}</td>
                    <td>{{ warehouse.capacity }}</td>
                    <td>
                        <a href="{{ url_for('farmer_dashboard.create_request_page') }}?warehouse_id={{ warehouse.id }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Request
                        </a>
                    </td>
                </tr>
                {% endfor %}
                {% if not warehouses %}
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="empty-state-container py-5">
                            <i class="fas fa-warehouse fa-3x mb-3"></i>
                            <p class="mb-3">No nearby warehouses found</p>
                            <button class="btn btn-primary">
                                <i class="fas fa-search"></i>
                                Expand Search Area
                            </button>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- New Request Modal -->
<!-- Removed as we now use direct links -->

<!-- View Map Modal -->
<div class="modal" id="mapModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Warehouse Locations</h3>
                <button class="close-modal-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="warehouseMap" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle modal visibility
function toggleModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.toggle('show');
    }
}

// View map buttons
document.getElementById('viewMapBtn').addEventListener('click', function() {
    toggleModal('mapModal');
    // Here you would initialize the map with warehouse locations
    showAlert('Map functionality will be implemented soon', 'info');
});

document.getElementById('viewMapBtnAlt').addEventListener('click', function() {
    toggleModal('mapModal');
    // Here you would initialize the map with warehouse locations
    showAlert('Map functionality will be implemented soon', 'info');
});

// Search functionality for requests
document.getElementById('requestSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#requestsTable tbody tr');
    
    rows.forEach(function(row) {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Search functionality for warehouses
document.getElementById('warehouseSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#warehousesTable tbody tr');
    
    rows.forEach(function(row) {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

function updateRequest(requestId, status) {
    // Check if jQuery is available
    if (typeof $ !== 'undefined') {
        $.post('/update_request', {
            request_id: requestId,
            status: status
        })
        .done(function(response) {
            showAlert('Request updated successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        })
        .fail(function(error) {
            showAlert('Failed to update request', 'error');
        });
    } else {
        // Fallback to fetch API if jQuery is not available
        fetch('/update_request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'request_id': requestId,
                'status': status
            })
        })
        .then(response => {
            if (response.ok) {
                showAlert('Request updated successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error('Failed to update request');
            }
        })
        .catch(error => {
            showAlert('Failed to update request', 'error');
        });
    }
}

function viewDetails(requestId) {
    // This would open a modal with request details
    showAlert('Viewing request details is not implemented yet', 'info');
}

function createRequest(warehouseId) {
    // Redirect to create request page with warehouse ID
    window.location.href = "{{ url_for('farmer_dashboard.create_request_page') }}?warehouse_id=" + warehouseId;
}

document.addEventListener('DOMContentLoaded', function() {
    // Time filter functionality
    const timeFilter = document.getElementById('timeFilter');
    if (timeFilter) {
        timeFilter.addEventListener('change', function() {
            const selectedValue = this.value;
            const rows = document.querySelectorAll('#requestsTable tbody tr');
            
            rows.forEach(row => {
                const dateCell = row.querySelector('td:nth-child(5)');
                if (!dateCell) return;
                
                const requestDate = new Date(dateCell.textContent);
                const now = new Date();
                let show = true;
                
                switch (selectedValue) {
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        show = requestDate >= weekAgo;
                        break;
                    case 'month':
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        show = requestDate >= monthAgo;
                        break;
                    case 'year':
                        const yearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                        show = requestDate >= yearAgo;
                        break;
                    default:
                        show = true;
                }
                
                row.style.display = show ? '' : 'none';
            });
            
            updateStatusCounts();
        });
    }
    
    // Function to update status counts and percentages
    function updateStatusCounts() {
        const visibleRows = Array.from(document.querySelectorAll('#requestsTable tbody tr')).filter(row => row.style.display !== 'none');
        const totalVisible = visibleRows.length;
        
        const statusTypes = ['pending', 'approved', 'rejected'];
        statusTypes.forEach(status => {
            const count = visibleRows.filter(row => {
                const statusCell = row.querySelector('td:nth-child(6) .badge');
                return statusCell && statusCell.textContent.toLowerCase() === status;
            }).length;
            
            const percentage = totalVisible > 0 ? (count / totalVisible * 100).toFixed(1) : 0;
            
            // Update count in status cards
            const countElement = document.querySelector(`.status-group:nth-child(${statusTypes.indexOf(status) + 1}) .font-bold`);
            if (countElement) countElement.textContent = count;
            
            // Update progress bar
            const progressBar = document.querySelector(`.status-group:nth-child(${statusTypes.indexOf(status) + 1}) .progress-bar`);
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
                progressBar.querySelector('.progress-text').textContent = `${percentage}%`;
            }
        });
    }
    
    // Search functionality
    const requestSearch = document.getElementById('requestSearch');
    if (requestSearch) {
        requestSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#requestsTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
            
            updateStatusCounts();
        });
    }
});
</script>
{% endblock %}
